<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Birbs!</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    	integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
    	crossorigin=""/>
	<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
		integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
		crossorigin=""></script>
	<link rel="icon" type="image/x-icon" href=".\293092.png">
	<style>
		#birdmap { /* Leafelet requires a starting height for maps or will assume 0 */
			height:450px;
		}
		#birbs {
			width: 100%;
			border: 1px solid;
			border-collapse: collapse;
		}
		th, td { 
			padding-left: 5px;
		}
		tr:hover {
			background-color: cadetblue;
			color: antiquewhite;
		}
		#species {
			width: 25%;
		}
		
	</style>
</head>
<body>
	<div id="birdmap"></div> <br />

	<label for="species">Choose bird species:</label>
	<select name="species" id="species">

	</select>
	
	<button id="getBirds" onclick="getBirds()">Get them birbs!</button>

	<button id="reMap" onclick="mymap.setView([params.lat, params.lng],10)">Re-center map</button>
	
	<table id="birbs">
		<tr id="birdRow"></tr>
	</table>

	<script>
		//url parameters for ebird API
		var params = {
			key: 'eo0j01ma9l9e',
			lat: '',
			lng: ''
			// snoowl1, baleag, coohaw
		};

		//ebird API url
		var url = 'https://api.ebird.org/v2/data/obs/geo/recent/';

		//empty nearby sightings array
		var nearMe = [];

		//initialize map for Leaflet
		const mymap = L.map('birdmap').setView([0, 0], 9);
		const attribution = '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap';
		const tileUrl = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';
		const tiles = L.tileLayer(tileUrl,{attribution});
		tiles.addTo(mymap);
		
		//create marker group for birds, enables easy clearing of the canvas when changing species
		var birdMarkers = L.featureGroup();

		//bird icon for Leaflet markers
		var birdIcon = L.icon({
			iconUrl: './293092.png',
			shadowUrl: '',
			iconSize:     [45, 45], // size of the icon
			shadowSize:   [50, 64], // size of the shadow
			iconAnchor:   [27, 27], // point of the icon which will correspond to marker's location
			shadowAnchor: [4, 62],  // the same for the shadow
			popupAnchor:  [-3, -26] // point from which the popup should open relative to the iconAnchor
		});

		//user icon for Leaflet markers
		var myIcon = L.icon({
			iconUrl: './2503463.png',
			shadowUrl: '',
			iconSize:     [60, 60], // size of the icon
			shadowSize:   [50, 64], // size of the shadow
			iconAnchor:   [27, 27], // point of the icon which will correspond to marker's location
			shadowAnchor: [4, 62],  // the same for the shadow
			popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
		});

		//create user location as const for cleaner updating of location using myMarker.setLatLng()
		const myMarker = L.marker([0, 0], {icon: myIcon}).addTo(mymap).bindPopup("<b>My Location</b><br />",params.lat,params.lng);

		//check if browser suppots geolocation, then get location and update params & url, and recenter map on your location
		if ('geolocation' in navigator) {
			console.log('location good');
			navigator.geolocation.getCurrentPosition(function(position)
			{
				params.lat = position.coords.latitude;
				params.lng = position.coords.longitude;
				console.log(params);
			
				//recenter the map to current location
				mymap.setView([params.lat, params.lng],13);
				myMarker.setLatLng([params.lat, params.lng]);	
				
				//fetch recent nearby sightings and populate species select options
				async function getNearby() {
					var speciesContainer = document.getElementById("species");
					var esc = encodeURIComponent;
					var query = Object.keys(params)
					.map(function(k) {return esc(k) + '=' + esc(params[k]);})
					.join('&');
					var nearResponse = await fetch(url +'?' + query);
					const nearBirds = await nearResponse.json();
					console.log(nearBirds);
					for (var i = 0; i < nearBirds.length; i++) {
						console.log('got ' + nearBirds.length + ' species nearby');
						var op = document.createElement("option");
						op.innerHTML = nearBirds[i].comName;
						op.value = nearBirds[i].speciesCode;
						op.ID = 'speciesOption';
						speciesContainer.appendChild(op);	
					};

					//alphabetize the select list
					var list, z, switching, b, shouldSwitch;
					list = document.getElementById("species");
					switching = true;
					// Make a loop that will continue until	no switching has been done
					while (switching) {
						//start by saying: no switching is done
						switching = false;
						b = list.getElementsByTagName("option");
						//loop through all list items
						for (z = 0; z < (b.length - 1); z++) {
							//start by saying there should be no switching:
							shouldSwitch = false;
							// Check if the next item should switch place with the current item
							if (b[z].innerHTML.toLowerCase() > b[z + 1].innerHTML.toLowerCase()) {
								//if next item is alphabetically lower than current item, mark as a switch and break the loop
								shouldSwitch = true;
								break;
							}
						}
						if (shouldSwitch) {
						//if a switch has been marked, make the switch	and mark the switch as done
							b[z].parentNode.insertBefore(b[z + 1], b[z]);
							switching = true;
						}
					}
				}	
			getNearby();

			});

		} else {
			console.log('location bad');
		};


		
		

		
		//get ebirds APi info on button click
		async function getBirds() {
			//get value from species selector
			var e = document.getElementById("species");
			var selectValue = e.value;
			var selectText = e.options[e.selectedIndex].text;
			console.log(selectValue);

			//clear any bird icons or table rows that are already on the screen
			var birdsContainer = document.getElementById("birbs");
			var rowCount = birdsContainer.rows.length;
			for (var i = rowCount - 1; i > 0; i--) {
				birdsContainer.deleteRow(i);
			};
			birdMarkers.clearLayers();

			//bang the url & params against the ebird api and add results to table rows
			var esc = encodeURIComponent;
			var query = Object.keys(params)
			.map(function(k) {return esc(k) + '=' + esc(params[k]);})
			.join('&');
			speciesUrl = url + selectValue + '?&' + query;
			const response = await fetch(speciesUrl);
			const birds = await response.json();
			console.log(birds);
			for (var i = 0; i < birds.length; i++) {
				console.log('got ' + birds.length + ' bird records');
				var row = document.createElement("tr");
				row.innerHTML = '<td id="birdRow">' + birds[i].comName + '</td><td>' + birds[i].obsDt + '</td><td>' + birds[i].locName + '</td>';
				birdsContainer.appendChild(row);	
			};

			//drop a bird icon on each location
			for (var j = 0; j < birds.length; j++) {
				var popInfo = '<b>' + birds[j].comName + '</b><br />' + birds[j].obsDt;
				L.marker([birds[j].lat,birds[j].lng], {icon:birdIcon}).addTo(birdMarkers).bindPopup(popInfo);
				birdMarkers.addTo(mymap);
			};

			//re-center the map & set zoom appropriate to results when done
			mymap.setView([params.lat, params.lng],10);
		};

	</script>

</body>
</html>